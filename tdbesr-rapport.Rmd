---
#title: "Tableaux de bord des universités  \nv0.5"
author: "Julien Gossa  \n gossa@unistra.fr"
date: "09/01/2020"
output: 
  pdf_document: 
    number_sections: yes
    includes:
      in_header: header.tex
      before_body: before_body.tex
    keep_tex: yes
    keep_md: yes
    latex_engine: xelatex
#urlcolor: blue
#linkcolor: blue
fontsize: 11pt
lang: "fr-FR"
geometry: margin=1.5cm
documentclass: report
classoption: landscape, legalpaper
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.align = "center", out.height="30%")

knitr::opts_chunk$set(pdf.options(encoding = "CP1250"))

library(kableExtra)
library(tidyverse)
library(cowplot)
library(pander)

library(kpiESR)
library(wikidataESR)

rentrée <- 2019
rentrée.deb <- 2013

strvar <- function(var) {
  s <- as.character(var)
  ifelse(str_length(s)>0,s,"N/A")
}

slugify <- function(x, alphanum_replace="", space_replace="_", tolower=TRUE) {
  x <- gsub("[^[:alnum:] ]", alphanum_replace, x)
  x <- gsub(" ", space_replace, x)
  if(tolower) { x <- tolower(x) }
  
  return(x)
}
```



# Avant-propos {-}

```{r child = 'avantpropos.Rmd', echo = FALSE, warning = FALSE}
```

```{=latex}
\vspace*{\fill}
```

```{r, out.width = "200pt"}
knitr::include_graphics("files/589px-Knowledge-Reid-Highsmith.png")
```


```{=latex}
\newpage
\begin{multicols}{2}
\tableofcontents
\newpage
\part{Présentation des données}
```


<!-- ```{r child = 'guide.Rmd', echo = FALSE, warning = FALSE} -->
<!-- ``` -->


```{=latex}
\end{multicols}
%\begin{changemargin}{-1cm}{-1cm}
```

```{=latex}
\newpage
\part{Etablissements}
```


```{r etab.loop, results="asis", message=FALSE, error=FALSE, echo = FALSE, warning = FALSE}

cat("```{=latex}")

strvar <- function(var, linkname=NA) {
  s <- as.character(var)
  s <- stringr::str_replace_all(s,'_','\\\\_')
  linkname <- stringr::str_replace_all(linkname,'_','\\\\_')
  
  if(is.na(s) | str_length(s)==0) {
    s <- "N/A"
  } else if (!is.na(linkname)) {
    s <- paste0("\\mbox{\\href{",s,"}{",linkname,"}}")
  }
  return(s)
}

etab_info <- function(etab) {
  list(
    type = strvar(etab$Type),
    ratt = strvar(etab$Rattachement),
    uai  = strvar(etab$UAI),
    swurl = strvar(etab$url.siteweb,etab$url.siteweb),
    wdurl = strvar(paste0("https://github.com/cpesr/wikidataESR/blob/master/plots/etablissements/",substr(etab$url.wikidata,33,50),".md"), substr(etab$url.wikidata,33,50)),
    lfurl = strvar(etab$url.legifrance, "Legifrance"),
    dans.tdb = ifelse(etab$UAI %in% esr.uais$dans.tdb,"Oui","Non"),
    dans.evol = ifelse(etab$UAI %in% esr.uais$dans.evol,"Oui","Non"),
    hors.norm = ifelse(etab$UAI %in% esr.uais$hors.norm,"Oui","Non")
    )
  
}

r2tex <- function(command, ...) {
  paste0("\\",command,
         paste0('{',list(...),'}', collapse=""))
}

list2texcom <- function(x,titre="") {
  paste0(length(x)," \\pdfcomment[icon=Note, color=royalblue(traditional)]{",
         titre," \\textCR\\textCR ",
         paste(x, collapse=" \\textCR "),
         "}")
}

note2texcom <- function(etab) {
  paste0("\\pdfcomment[icon=Note]{",stringr::str_replace_all(etab$Notes,";","\\textCR"),"}")
}

cat_etab_slide <- function(etab) {
  info <- etab_info(etab)
  cat(sep = '',"\n\n",
    r2tex("etabpage[section]",
          etab$Etablissement,
          paste0("plot/",etab$UAI,"-kpi"),
          r2tex("makeinfo",info$swurl,info$type,info$lfurl,info$uai,info$wdurl,etab$Académie,
                note2texcom(etab),
                paste(info$dans.tdb,info$dans.evol,info$hors.norm)))
  )

  cat(sep = '',"\n\n",
    r2tex("etabpage",
          etab$Etablissement,
          paste0("plot/",etab$UAI,"-series"),
          r2tex("makeinfo",info$swurl,info$type,info$lfurl,info$uai,info$wdurl,etab$Académie,
                note2texcom(etab),
                paste(info$dans.tdb,info$dans.evol,info$hors.norm)))
  )
}

cat_groupe_slide <- function(groupe) {
  groupefn <- slugify(groupe)
  cat(sep = '',"\n\n",
    r2tex("groupepage[section]",
          groupe,
          paste0("plot/",groupefn,"-kpi"))
  )

  cat(sep = '',"\n\n",
    r2tex("etabpage",
          groupe,
          paste0("plot/",groupefn,"-series"),
          r2tex("makegrpinfo",
            list2texcom(esr.etab %>% filter(Groupe == groupe) %>% pull(Etablissement), 
                        "Liste des établisssement du groupe (y compris disparus)"),
            list2texcom(esr.etab %>% filter(Groupe == groupe, 
                                            !UAI %in% esr.uais$dans.tdb) %>% pull(Etablissement),
                        "Liste des établissements exclus des tableaux de bord (disparus ou données trop partielles"),
            list2texcom(esr.etab %>% filter(Groupe == groupe, 
                                            UAI %in% esr.uais$dans.evol) %>% pull(Etablissement),
                        "Liste des établissements inclus dans les statistiques du groupe (données complètes)"),
                      list2texcom(esr.etab %>% filter(Groupe == groupe, 
                                                      UAI %in% esr.uais$hors.norm) %>% pull(Etablissement),
                        "Liste des établissements exclus des représentations des distributions (données trop hors normes)")
            )
    )
    )
}

uai.unistra <- "0673021V"

etabs <- esr.etab %>% filter(Etablissement %in% c("Université de Strasbourg","Université de Lorraine","Sciences Po Aix"))
#etabs <- esr.etab %>% filter(UAI %in% esr.uais$dans.tdb) %>% arrange(Groupe,Etablissement)
#etabs <- esr.etab %>% filter(dataset == "CPESR") %>% arrange(Groupe,Etablissement)
aca <- ""
groupe <- ""

cat_groupe_slide("Ensemble")

for (i in seq(1,nrow(etabs))) {
  etab <- etabs[i,]
  
  message("\nProcessing ",i,"/",nrow(etabs)," : ",strvar(etab$Etablissement))
  
  if(etab$Groupe != groupe) {
    groupe <- as.character(etab$Groupe)
    cat_groupe_slide(groupe)
  }
  
  cat_etab_slide(etab)
}

cat("\n\n```")
```


```{=latex}
\newpage
\checkoddpage \ifoddpage ~\\\newpage  \fi

\vspace*{5cm}
\part{Classements des universités}
\newpage

\scriptsize
\def\arraystretch{1.2}
```


```{r classement.functions, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement <- function(groupe,kpis,labels) {
  kpiesr_classement(rentrée, rentrée.deb, groupe, kpis) %>%
    kable("latex", longtable = T, booktabs = T, align = c("r","l",rep("r",length(kpis)),"r","r"),
          col.names=NULL) %>%
    add_header_above(c("Rang","Etablissement",labels,"Rang 2013" = 2)) %>%
    kable_styling(latex_options = c("striped", "repeat_header")) %>% 
    column_spec(c(1,3:7), monospace = TRUE)
    # add_header_above(c("Rang et écart à la moyenne" = 3, "Détails" = length(kpis), "Historique"=length(hist)))
}

 

table_classement_slice <- function(rentrée,type,kpis,labels,rows)
  kpiesr_classement(rentrée, type, kpis, labels) %>%
    slice(rows) %>%
    mutate(Libellé = str_replace(Libellé,"Université","UN.")) %>%
    kable("latex", longtable = T, booktabs = T, 
          align = c("r","r","l",rep("r",4)),
          col.names = c("","Ecart","Libellé",labels)) %>%
    kable_styling(latex_options = c("striped"), full_width = F, font_size = 7) 

table_classement_sbs <- function(rentrée,type,kpis,labels,row) {
  cat("\\begin{minipage}{0.50\\textwidth}   \n")
  print(table_classement_slice(rentrée,type,kpis,labels, 1:34))
  cat("\\end{minipage}  \\begin{minipage}{0.50\\textwidth}  \n")
  print(table_classement_slice(rentrée,type,kpis,labels, 35:70))
  cat("\\end{minipage}")
}

```


# Taux de ressources propres

\vspace{-5cm}

```{r classement.dotPres, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement("Universités et assimilés",
                 c("kpi.K.dotPres", "kpi.FIN.P.ressources","kpi.FIN.S.SCSP"),
                 c("Taux de SCSP","Ressources totales","SCSP")) 
```

\newpage
# Taux de ressources par étudiant (inscrit en cycles 1 (L) et 2 (M))

\vspace{-5cm}

```{r classement.RpE, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement("Universités et assimilés",
                  c("kpi.K.resPetu", "kpi.FIN.P.ressources","kpi.ETU.S.cycle1_L","kpi.ETU.S.cycle2_M"),
                  c("Taux","Ressources","Effectif L","Effectif M"))
```


# Taux d'encadrement

\vspace{-5cm}

```{r classement.EpE, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement("Universités et assimilés",
                  c("kpi.K.ensPetu", "kpi.ENS.P.effectif","kpi.ETU.S.cycle1_L","kpi.ETU.S.cycle2_M"),
                  c("Taux","Enseignants","Effectif L","Effectif M"))
```


\newpage
# Taux de titularité

\vspace{-5cm}

```{r classement.TpE, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement("Universités et assimilés",
                  c("kpi.K.titPens", "kpi.ENS.P.effectif", "kpi.ENS.S.titulaires"),
                  c("Taux","Enseignants","Titulaires"))
```

\newpage
# Recette formation par étudiant

\vspace{-5cm}

```{r classement.fPe, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement("Universités et assimilés",
                  c("kpi.K.forPetu","kpi.FIN.S.recettesFormation","kpi.ETU.P.effectif"),
                  c("Taux","Recettes formation","Effectifs étudiants"))
```


\newpage
# Recette recherche par EC titulaire

\vspace{-5cm}

```{r classement.rPe, echo = FALSE, warning = FALSE, eval=TRUE}
table_classement("Universités et assimilés",
                  c("kpi.K.recPect","kpi.FIN.S.recettesFormation","kpi.ENS.S.ECtitulaires"),
                  c("Taux","Recettes recherche","Effectifs EC titulaires"))
```
