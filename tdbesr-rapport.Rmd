---
#title: "Tableaux de bord des universités  \nv0.5"
author: "Julien Gossa  \n gossa@unistra.fr"
date: "09/01/2020"

output: 
  pdf_document:
    # toc: true
    # toc_depth: 3
    number_sections: true
    includes:
      in_header: header.tex
      before_body: before_body.tex
    keep_tex:  true
#urlcolor: blue
#linkcolor: blue
fontsize: 11pt
lang: "fr-FR"
geometry: margin=1.5cm
documentclass: report
classoption: landscape, legalpaper
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.align = "center", out.height="30%")

knitr::opts_chunk$set(pdf.options(encoding = "CP1250"))

library(kableExtra)
library(tidyverse)
library(cowplot)
library(pander)

library(kpiESR)
library(wikidataESR)

rentrée <- 2019
type <- "Université"

strvar <- function(var) {
  s <- as.character(var)
  ifelse(str_length(s)>0,s,"N/A")
}

slugify <- function(x, alphanum_replace="", space_replace="_", tolower=TRUE) {
  x <- gsub("[^[:alnum:] ]", alphanum_replace, x)
  x <- gsub(" ", space_replace, x)
  if(tolower) { x <- tolower(x) }
  
  return(x)
}
```


# Avant-propos {-}

```{r child = 'avantpropos.Rmd', echo = FALSE, warning = FALSE}
```

```{=latex}
\vspace*{\fill}
```

```{r, out.width = "200px"}
knitr::include_graphics("files/589px-Knowledge-Reid-Highsmith.png")
```


```{=latex}
\newpage
\begin{multicols}{2}
\tableofcontents
\newpage
\part{Présentation des données}
```


<!-- ```{r child = 'guide.Rmd', echo = FALSE, warning = FALSE} -->
<!-- ``` -->


```{=latex}
\end{multicols}
%\begin{changemargin}{-1cm}{-1cm}
```

```{=latex}
\newpage
\part{Etablissements}
```


```{r etab.loop, results="asis", message=FALSE, error=FALSE, echo = FALSE, warning = FALSE}

strvar <- function(var, linkname=NA) {
  s <- as.character(var)
  if(is.na(s) | str_length(s)==0) {
    s <- "N/A"
  } else if (!is.na(linkname)) {
    s <- paste0("\\mbox{\\href{",s,"}{",linkname,"}}")
  }
  return(s)
}

etab_info <- function(etab) {
  list(
    type = strvar(etab$Type),
    ratt =  strvar(etab$Rattachement),
    uai  = strvar(etab$UAI),
    swurl = strvar(etab$url.siteweb,etab$url.siteweb),
    wdurl = strvar(paste0("https://github.com/cpesr/wikidataESR/blob/master/plots/etablissements/",substr(etab$url.wikidata,33,50),".md"), substr(etab$url.wikidata,33,50)),
    lfurl = strvar(etab$url.legifrance, "Legifrance"))
}

r2tex <- function(command, ...) {
  paste0("\\",command,
         paste0('{',list(...),'}', collapse=""))
}

cat_etab_slide <- function(etab) {
  info <- etab_info(etab)
  cat(sep = '',"\n\n",
    r2tex("etabpage[section]",
          etab$Etablissement,
          paste0("plot/",etab$UAI,"-kpi"),
          r2tex("makeinfo",info$swurl,info$type,info$lfurl,info$uai,info$wdurl,etab$Académie))
  )

  cat(sep = '',"\n\n",
    r2tex("etabpage",
          etab$Etablissement,
          paste0("plot/",etab$UAI,"-series"),
          r2tex("makeinfo",info$swurl,info$type,info$lfurl,info$uai,info$wdurl,etab$Académie))
  )
}

cat_groupe_slide <- function(groupe) {
  groupefn <- slugify(groupe)
  cat(sep = '',"\n\n",
    r2tex("groupepage[section]",
          groupe,
          paste0("plot/",groupefn,"-kpi"))
  )

  cat(sep = '',"\n\n",
    r2tex("etabpage",
          groupe,
          paste0("plot/",groupefn,"-series"),
          "placeholder")
  )
}

uai.unistra <- "0673021V"

etabs <- esr.etab %>% filter(Etablissement %in% c("Université de Strasbourg","Université de Lorraine","Sciences Po Aix"))
etabs <- esr.etab %>% filter(UAI %in% esr.uais$dans.tdb) %>% arrange(Groupe,Académie,Etablissement)
aca <- ""
groupe <- ""

cat_groupe_slide("Ensemble")

for (i in seq(1,nrow(etabs))) {
  etab <- etabs[i,]
  
  message("\nProcessing ",i,"/",nrow(etabs)," : ",strvar(etab$Etablissement))
  
  if(etab$Groupe != groupe) {
    groupe <- as.character(etab$Groupe)
    cat_groupe_slide(groupe)
  }
  
  cat_etab_slide(etab)
}
```


```{=latex}
\newpage
\checkoddpage \ifoddpage ~\\\newpage  \fi

\vspace*{5cm}
\part{Classements des universités}
\newpage

\scriptsize
\def\arraystretch{1.2}
```


# Taux de ressources propres
```{r classement.functions, echo = FALSE, warning = FALSE, eval=FALSE}
rentrée_hist <- 2012
hist <- seq(rentrée_hist, rentrée)

table_classement <- function(rentrée,type,kpis,labels)
  kpiesr_classement(rentrée, type, kpis, labels, hist) %>%
    kable("latex", longtable = T, booktabs = T, align = c("r","r","l",rep("r",4))) %>%
    kable_styling(latex_options = c("striped", "repeat_header")) %>%
    add_header_above(c("Rang et écart à la moyenne" = 3, "Détails" = length(kpis), "Historique"=length(hist)))

table_classement_slice <- function(rentrée,type,kpis,labels,rows)
  kpiesr_classement(rentrée, type, kpis, labels) %>%
    slice(rows) %>%
    mutate(Libellé = str_replace(Libellé,"Université","UN.")) %>%
    kable("latex", longtable = T, booktabs = T, 
          align = c("r","r","l",rep("r",4)),
          col.names = c("","Ecart","Libellé",labels)) %>%
    kable_styling(latex_options = c("striped"), full_width = F, font_size = 7) 

table_classement_sbs <- function(rentrée,type,kpis,labels,row) {
  cat("\\begin{minipage}{0.50\\textwidth}   \n")
  print(table_classement_slice(rentrée,type,kpis,labels, 1:34))
  cat("\\end{minipage}  \\begin{minipage}{0.50\\textwidth}  \n")
  print(table_classement_slice(rentrée,type,kpis,labels, 35:70))
  cat("\\end{minipage}")
}

table_classement(rentrée, "Université",
                  c("kpi.K.proPres", 
                    "kpi.FIN.P.ressources", 
                    "kpi.FIN.S.ressourcesPropres"),
                  c("Taux","Ressources","Res. Propres")) 
```


\newpage
# Taux de ressources par étudiant (inscrit en cycles 1 (L) et 2 (M))
```{r classement.RpE, echo = FALSE, warning = FALSE, eval=FALSE}
table_classement(rentrée, "Université",
                  c("kpi.K.resPetu", "kpi.FIN.P.ressources","kpi.ETU.S.cycle.1.L","kpi.ETU.S.cycle.2.M"),
                  c("Taux","Ressources","Effectif L","Effectif M"))
```

<!-- ## Taux de formations sélectives -->

<!-- ```{r classement.FS} -->
<!-- table_classement(rentrée, "Université", -->
<!--                   c("kpi.K.selPfor", "kpi.ADM.P.formations","kpi.ADM.S.sélective"), -->
<!--                   c("Taux","Formations","Formations sélectives")) -->
<!-- ``` -->


# Taux d'encadrement
```{r classement.EpE, echo = FALSE, warning = FALSE, eval=FALSE}
table_classement(rentrée, "Université",
                  c("kpi.K.titPetu", "kpi.ENS.S.titulaires","kpi.ETU.P.effectif"),
                  c("Taux","Ens. titulaires","Etudiants"))
```


\newpage
# Taux de titularité
```{r classement.TpE, echo = FALSE, warning = FALSE, eval=FALSE}
table_classement(rentrée, "Université",
                  c("kpi.K.titPens", "kpi.ENS.P.effectif", "kpi.ENS.S.titulaires"),
                  c("Taux","Enseignants","Titulaires"))
```

